<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
  <title>Prospera - Gestão Inteligente</title>
  
  <script src="https://cdn.tailwindcss.com"></script>
  
  <script>
    tailwind.config = {
      darkMode: 'class',
      theme: {
        extend: {
          fontFamily: {
            sans: ['Outfit', 'sans-serif'],
            body: ['Inter', 'sans-serif'],
          },
          colors: {
            background: '#09090b',
            surface: '#18181b',
            primary: '#8b5cf6',
            secondary: '#ec4899',
            accent: '#06b6d4',
            gold: '#fbbf24',
          },
          animation: {
            'fade-in': 'fadeIn 0.4s cubic-bezier(0.16, 1, 0.3, 1)',
            'slide-up': 'slideUp 0.5s cubic-bezier(0.16, 1, 0.3, 1)',
            'slide-in-right': 'slideInRight 0.4s cubic-bezier(0.16, 1, 0.3, 1)',
            'float': 'float 6s ease-in-out infinite',
            'pulse-slow': 'pulse 4s cubic-bezier(0.4, 0, 0.6, 1) infinite',
            'shimmer': 'shimmer 2s infinite',
            'spin-slow': 'spin 3s linear infinite',
          },
          keyframes: {
            fadeIn: { '0%': { opacity: '0' }, '100%': { opacity: '1' } },
            slideUp: { '0%': { transform: 'translateY(20px)', opacity: '0' }, '100%': { transform: 'translateY(0)', opacity: '1' } },
            slideInRight: { '0%': { transform: 'translateX(100%)', opacity: '0' }, '100%': { transform: 'translateX(0)', opacity: '1' } },
            float: { '0%, 100%': { transform: 'translateY(0)' }, '50%': { transform: 'translateY(-10px)' } },
            shimmer: { '0%': { transform: 'translateX(-100%)' }, '100%': { transform: 'translateX(100%)' } }
          },
          screens: {
            'xs': '375px',
          }
        }
      }
    }
  </script>
  
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700;800&family=Inter:wght@300;400;500;600&display=swap" rel="stylesheet">

  <script type="importmap">
    {
      "imports": {
        "react": "https://esm.sh/react@18.2.0",
        "react-dom": "https://esm.sh/react-dom@18.2.0",
        "react-dom/client": "https://esm.sh/react-dom@18.2.0/client",
        "recharts": "https://esm.sh/recharts@2.12.0?external=react,react-dom",
        "lucide-react": "https://esm.sh/lucide-react@0.300.0?external=react,react-dom"
      }
    }
  </script>

  <style>
    body { font-family: 'Inter', sans-serif; -webkit-tap-highlight-color: transparent; }
    h1, h2, h3, h4, button, .font-heading { font-family: 'Outfit', sans-serif; }
    
    ::-webkit-scrollbar { width: 6px; height: 6px; }
    ::-webkit-scrollbar-track { background: transparent; }
    ::-webkit-scrollbar-thumb { background: #3f3f46; border-radius: 10px; }
    ::-webkit-scrollbar-thumb:hover { background: #52525b; }

    .glass {
      background: rgba(255, 255, 255, 0.03);
      backdrop-filter: blur(16px);
      -webkit-backdrop-filter: blur(16px);
      border: 1px solid rgba(255, 255, 255, 0.08);
      box-shadow: 0 4px 30px rgba(0, 0, 0, 0.1);
    }
    
    .bg-gradient-animate {
      background: radial-gradient(circle at 50% 0%, rgba(139, 92, 246, 0.15), transparent 40%),
                  radial-gradient(circle at 80% 50%, rgba(6, 182, 212, 0.1), transparent 40%);
    }

    select { color-scheme: dark; }
    option { background-color: #18181b !important; color: #ffffff !important; padding: 10px; }
    .dark option { background-color: #18181b !important; color: #ffffff !important; }
    ::-webkit-calendar-picker-indicator { filter: invert(1); opacity: 0.6; cursor: pointer; }
    
    .pb-safe { padding-bottom: env(safe-area-inset-bottom); }
    .pt-safe { padding-top: env(safe-area-inset-top); }
    .no-scrollbar::-webkit-scrollbar { display: none; }
    .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
  </style>
</head>
<body class="bg-slate-50 dark:bg-[#09090b] text-slate-900 dark:text-slate-100 transition-colors duration-500 min-h-screen selection:bg-violet-500/30 overflow-hidden">
  <div id="root"></div>

  <script type="text/babel" data-type="module">
    import React, { useState, useEffect, useMemo, useRef } from 'react';
    import { createRoot } from 'react-dom/client';
    import { PieChart, Pie, Cell, BarChart, Bar, XAxis, YAxis, CartesianGrid, Tooltip as RechartsTooltip, Legend, ResponsiveContainer, AreaChart, Area, LineChart, Line } from 'recharts';
    import { Wallet, TrendingUp, TrendingDown, Target, CreditCard, DollarSign, Menu, X, Plus, ArrowUpRight, ArrowDownRight, LayoutDashboard, ListFilter, Trash2, Calendar as CalendarIcon, Save, Moon, Sun, Download, Upload, RefreshCw, AlertCircle, Coins, Calculator, PiggyBank, Edit2, Lock, Unlock, Eye, EyeOff, ShieldCheck, LogOut, Gem, Activity, Landmark, CalendarDays, Sprout, MoreHorizontal, ChevronLeft, ChevronRight, Repeat, Search, Filter, ArrowUp, ArrowDown, CheckCircle, XCircle, ArrowUpDown, Trophy, Building2, Briefcase, CalendarClock } from 'lucide-react';

    // CONSTANTES
    const CATEGORIES = {
      expense: { 'Moradia': [], 'Alimentação': [], 'Transporte': [], 'Lazer': [], 'Pessoal': [], 'Serviços': [], 'Outros': [] },
      income: { 'Salário': [], 'Extra': [] }
    };
    const CATEGORY_COLORS = { 'Moradia': '#8b5cf6', 'Alimentação': '#f59e0b', 'Transporte': '#ef4444', 'Lazer': '#06b6d4', 'Pessoal': '#ec4899', 'Serviços': '#6366f1', 'Outros': '#64748b', 'Salário': '#10b981', 'Extra': '#3b82f6' };
    const PAYMENT_METHODS = [ { id: 'pix', label: 'Pix' }, { id: 'money', label: 'Dinheiro' }, { id: 'debit', label: 'Débito' }, { id: 'credit_card', label: 'Cartão de Crédito' } ];
    
    // HELPERS
    const formatCurrency = (val, hid) => hid ? '••••' : new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' }).format(val || 0);
    const formatDate = (s) => { if (!s) return ''; const [y, m, d] = s.split('-'); return `${d}/${m}/${y}`; };

    const theme = {
      card: "glass rounded-[24px] md:rounded-[32px] p-5 md:p-6 transition-all hover:border-white/20 dark:hover:border-white/10 relative overflow-hidden group",
      input: "w-full rounded-xl border-0 bg-white dark:bg-[#18181b] border border-slate-200 dark:border-white/10 px-4 py-3.5 md:px-5 md:py-4 text-slate-900 dark:text-white outline-none ring-1 ring-transparent focus:ring-violet-500/50 transition-all placeholder:text-slate-400 font-medium text-sm md:text-base shadow-sm",
      label: "mb-1.5 md:mb-2 block text-xs font-bold uppercase tracking-widest text-slate-500 dark:text-slate-400 ml-1",
      btnPrimary: "flex items-center justify-center gap-2 rounded-2xl bg-white dark:bg-white text-slate-900 py-3.5 px-5 font-bold shadow-xl shadow-white/10 transition-all hover:scale-[1.02] active:scale-[0.98] text-sm tracking-wide w-full cursor-pointer touch-manipulation",
      btnAccent: "flex items-center justify-center gap-2 rounded-xl bg-violet-600 text-white py-3 px-4 md:py-3.5 md:px-6 font-bold shadow-xl shadow-violet-600/20 transition-all hover:bg-violet-500 hover:scale-[1.02] active:scale-[0.98] text-xs md:text-sm tracking-wide cursor-pointer touch-manipulation",
    };

    // COMPONENTS UI
    const Modal = ({ isOpen, onClose, title, children }) => {
      useEffect(() => { const h = (e) => { if (e.key === 'Escape') onClose(); }; if (isOpen) window.addEventListener('keydown', h); return () => window.removeEventListener('keydown', h); }, [isOpen, onClose]);
      if (!isOpen) return null;
      return (<div className="fixed inset-0 z-[60] flex items-center justify-center bg-black/90 backdrop-blur-md p-4 animate-fade-in" onClick={(e)=>e.target===e.currentTarget&&onClose()}><div className="w-full max-w-lg bg-[#0f172a] border border-slate-800 rounded-[24px] shadow-2xl animate-slide-up relative overflow-hidden flex flex-col max-h-[85vh] md:max-h-[90vh]"><div className="p-4 md:p-5 border-b border-white/5 flex items-center justify-between shrink-0"><h3 className="text-lg md:text-xl font-bold text-white flex items-center gap-2 truncate">{title}</h3><button onClick={onClose} className="rounded-full p-2 text-slate-400 hover:bg-white/10 hover:text-white transition-colors"><X size={20}/></button></div><div className="overflow-y-auto custom-scrollbar p-4 md:p-5">{children}</div></div></div>);
    };
    const Card = ({ children, className = "" }) => <div className={`${theme.card} ${className}`}>{children}</div>;
    const CustomLogo = () => (<div className="w-10 h-10 md:w-16 md:h-16 bg-gradient-to-tr from-emerald-500 to-green-600 rounded-xl md:rounded-2xl flex items-center justify-center shadow-lg shadow-emerald-500/30 mb-0 md:mb-8 md:animate-float shrink-0"><Sprout className="text-white" size={20} /></div>);
    const ToastContainer = ({ toasts }) => (<div className="fixed bottom-24 md:bottom-10 right-4 md:right-10 z-[100] flex flex-col gap-3 pointer-events-none w-[calc(100%-2rem)] md:w-auto">{toasts.map(t=><div key={t.id} className={`pointer-events-auto flex items-center gap-3 px-5 py-4 rounded-xl shadow-2xl border border-white/10 text-white font-medium animate-slide-in-right ${t.type==='error'?'bg-rose-600':'bg-[#18181b]'} backdrop-blur-xl`}>{t.type==='success'?<CheckCircle size={20} className="text-emerald-400 shrink-0"/>:<XCircle size={20} className="text-white shrink-0"/>}<span className="truncate">{t.msg}</span></div>)}</div>);
    const MonthSelector = ({ currentDate, onChange }) => (<div className="flex items-center gap-1 md:gap-2 bg-slate-200 dark:bg-[#18181b] p-1 rounded-xl border border-slate-300 dark:border-white/5"><button onClick={()=>onChange(new Date(currentDate.getFullYear(), currentDate.getMonth()-1, 1))} className="p-1.5 rounded-lg hover:bg-white dark:hover:bg-white/10 text-slate-600 dark:text-slate-400 transition-colors"><ChevronLeft size={18}/></button><span className="text-xs md:text-sm font-bold text-slate-800 dark:text-white capitalize min-w-[100px] md:min-w-[120px] text-center">{currentDate.toLocaleDateString('pt-BR',{month:'long',year:'numeric'})}</span><button onClick={()=>onChange(new Date(currentDate.getFullYear(), currentDate.getMonth()+1, 1))} className="p-1.5 rounded-lg hover:bg-white dark:hover:bg-white/10 text-slate-600 dark:text-slate-400 transition-colors"><ChevronRight size={18}/></button></div>);

    // --- AUTH SCREEN ---
    const AuthScreen = ({ onLogin, onRegister, onRecover }) => {
        const [mode, setMode] = useState('login'); 
        const [formData, setFormData] = useState({ name: '', pin: '', confirmPin: '', question: 'Qual o nome do seu primeiro animal de estimação?', answer: '' });
        const [keepLogged, setKeepLogged] = useState(false);
        const [error, setError] = useState('');
        const [success, setSuccess] = useState('');

        const handleChange = (e) => setFormData({...formData, [e.target.name]: e.target.value});

        const handleSubmit = (e) => {
            e.preventDefault(); setError(''); setSuccess('');
            if(mode === 'login') {
                onLogin(formData.pin, keepLogged, setError);
            } else if (mode === 'register') {
                if(formData.pin !== formData.confirmPin) return setError('PINs não conferem');
                if(formData.pin.length < 4) return setError('Mínimo 4 dígitos');
                onRegister(formData, setError, () => { setSuccess('Conta criada! Faça login.'); setMode('login'); });
            } else {
                onRecover(formData, setError, () => { setSuccess('Senha alterada! Faça login.'); setMode('login'); });
            }
        };

        return (
            <div className="min-h-screen flex items-center justify-center p-4 bg-[#050505] relative overflow-hidden">
                <div className="absolute w-[800px] h-[800px] bg-violet-600/20 rounded-full blur-[120px] animate-pulse-slow"></div>
                <div className="w-full max-w-md bg-[#0f172a]/90 backdrop-blur-2xl border border-white/10 rounded-[32px] shadow-2xl p-6 md:p-10 relative z-10 animate-fade-in flex flex-col items-center">
                    <div className="mb-4 scale-125"><CustomLogo /></div>
                    <h1 className="text-3xl font-extrabold text-white mb-2 tracking-tight">Prospera</h1>
                    <p className="text-slate-400 font-medium mb-6">O cofre do seu futuro</p>
                    <form onSubmit={handleSubmit} className="w-full space-y-4">
                        {(mode === 'register' || mode === 'recover') && (<div><label className={theme.label}>Seu Nome</label><input name="name" value={formData.name} onChange={handleChange} className={theme.input} placeholder="Ex: Eduardo" autoFocus /></div>)}
                        {mode === 'register' && (<div><label className={theme.label}>Pergunta Secreta</label><select name="question" value={formData.question} onChange={handleChange} className={theme.input}><option>Qual o nome do seu primeiro animal de estimação?</option><option>Qual a cidade onde você nasceu?</option><option>Qual sua comida favorita?</option></select></div>)}
                        {(mode === 'register' || mode === 'recover') && (<div><label className={theme.label}>Resposta Secreta</label><input name="answer" value={formData.answer} onChange={handleChange} className={theme.input} placeholder="Sua resposta" /></div>)}
                        <div><label className={theme.label}>{mode === 'recover' ? 'Novo PIN' : 'Código PIN'}</label><input type="password" inputMode="numeric" name="pin" value={formData.pin} onChange={handleChange} className={`${theme.input} text-center text-2xl tracking-widest`} placeholder="••••" maxLength={6} /></div>
                        {mode === 'register' && (<div><label className={theme.label}>Confirmar PIN</label><input type="password" inputMode="numeric" name="confirmPin" value={formData.confirmPin} onChange={handleChange} className={`${theme.input} text-center text-2xl tracking-widest`} placeholder="••••" maxLength={6} /></div>)}
                        {mode === 'login' && (<div className="flex items-center gap-2 justify-center py-2"><input type="checkbox" id="keep" checked={keepLogged} onChange={e => setKeepLogged(e.target.checked)} className="w-4 h-4 accent-violet-600 rounded cursor-pointer" /><label htmlFor="keep" className="text-sm text-slate-400 cursor-pointer">Manter conectado</label></div>)}
                        {error && <div className="text-rose-400 text-sm text-center bg-rose-500/10 p-3 rounded-xl border border-rose-500/20">{error}</div>}
                        {success && <div className="text-emerald-400 text-sm text-center bg-emerald-500/10 p-3 rounded-xl border border-emerald-500/20">{success}</div>}
                        <button type="submit" className={theme.btnPrimary}>{mode === 'login' ? 'Entrar' : mode === 'register' ? 'Criar Conta' : 'Redefinir Senha'}</button>
                    </form>
                    <div className="mt-6 flex justify-center gap-4 text-sm font-medium">
                        {mode === 'login' && (<><button onClick={() => setMode('recover')} className="text-slate-400 hover:text-white">Esqueci PIN</button><span className="text-slate-600">|</span><button onClick={() => setMode('register')} className="text-violet-400 hover:text-violet-300 font-bold">Criar conta</button></>)}
                        {mode !== 'login' && (<button onClick={() => setMode('login')} className="text-slate-400 hover:text-white">Voltar para Login</button>)}
                    </div>
                </div>
            </div>
        );
    };

    // --- SUB-COMPONENTS (RESTORED) ---
    const SettingsModal = ({ isOpen, onClose, onLogout }) => (<Modal isOpen={isOpen} onClose={onClose} title="Segurança"><div className="space-y-6"><div className="bg-[#1e293b]/50 border border-blue-500/20 rounded-2xl p-5"><h4 className="text-blue-400 font-bold flex items-center gap-2 mb-2">Dados na Nuvem</h4><p className="text-slate-400 text-sm mb-4">Seus dados estão salvos no banco de dados.</p></div><div className="pt-4 border-t border-slate-800 text-center"><button onClick={onLogout} className="text-rose-500 hover:text-rose-400 font-bold flex items-center justify-center gap-2 w-full py-2 transition-colors"><LogOut size={18}/> Sair e Bloquear</button></div></div></Modal>);
    
    const DayDetailsModal = ({ isOpen, onClose, date, transactions, onDelete, onAdd, onEdit }) => { if (!isOpen) return null; const inc = transactions.filter(t=>t.type==='income').reduce((a,c)=>a+c.amount,0); const exp = transactions.filter(t=>t.type==='expense').reduce((a,c)=>a+c.amount,0); return (<Modal isOpen={isOpen} onClose={onClose} title={`Dia ${formatDate(date)}`}><div className="space-y-6"><div className="flex gap-4"><div className="flex-1 bg-emerald-500/10 p-4 rounded-2xl text-center"><span className="text-xs font-bold text-emerald-400">ENTRADAS</span><p className="text-lg font-bold text-white">{formatCurrency(inc)}</p></div><div className="flex-1 bg-rose-500/10 p-4 rounded-2xl text-center"><span className="text-xs font-bold text-rose-400">SAÍDAS</span><p className="text-lg font-bold text-white">{formatCurrency(exp)}</p></div></div><div><h4 className="text-slate-400 text-sm font-bold mb-3 uppercase">Transações</h4><div className="space-y-3">{transactions.map(t=>(<div key={t.id} className="flex justify-between items-center bg-white/5 p-4 rounded-2xl"><div><p className="font-bold text-white">{t.description}</p><p className="text-xs text-slate-500">{t.category}</p></div><div className="flex items-center gap-3"><span className={t.type==='income'?'text-emerald-400':'text-rose-400'}>{formatCurrency(t.amount)}</span><button onClick={()=>{onClose();onEdit(t)}} className="text-slate-500 hover:text-blue-400"><Edit2 size={16}/></button><button onClick={()=>onDelete(t.id)} className="text-slate-500 hover:text-rose-500"><Trash2 size={16}/></button></div></div>))}</div></div><button onClick={onAdd} className={theme.btnAccent}><Plus size={18}/> Nova</button></div></Modal>); };

    // --- VIEWS ---
    const Overview = ({ transactions = [], goals, privacyMode, toggleModal, setPrefilledDate, user }) => {
      const [currentDate, setCurrentDate] = useState(new Date());
      const safeTrans = Array.isArray(transactions) ? transactions : [];
      const filtered = useMemo(() => safeTrans.filter(t => { const d = new Date(t.date); const adj = new Date(d.getTime() + d.getTimezoneOffset()*60000); return adj.getMonth()===currentDate.getMonth() && adj.getFullYear()===currentDate.getFullYear(); }), [safeTrans, currentDate]);
      const prevBal = useMemo(() => { const start = new Date(currentDate.getFullYear(), currentDate.getMonth(), 1); start.setHours(0,0,0,0); return safeTrans.filter(t => { const d = new Date(t.date); const adj = new Date(d.getTime() + d.getTimezoneOffset()*60000); return adj < start; }).reduce((acc, t) => acc + (t.type==='income'?Number(t.amount):-Number(t.amount)), 0); }, [safeTrans, currentDate]);
      const inc = filtered.filter(t=>t.type==='income').reduce((a,t)=>a+Number(t.amount),0);
      const exp = filtered.filter(t=>t.type==='expense').reduce((a,t)=>a+Number(t.amount),0);
      const balance = inc - exp;
      const total = prevBal + balance;
      const areaData = useMemo(() => { const days = new Date(currentDate.getFullYear(), currentDate.getMonth()+1, 0).getDate(); return Array.from({length:days},(_,i)=>{ const d=i+1; const dateStr=`${currentDate.getFullYear()}-${String(currentDate.getMonth()+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`; const dt=filtered.filter(t=>t.date===dateStr); return { name:String(d), Entradas:dt.filter(t=>t.type==='income').reduce((a,c)=>a+Number(c.amount),0), Saídas:dt.filter(t=>t.type==='expense').reduce((a,c)=>a+Number(c.amount),0) }; }); }, [filtered, currentDate]);
      const catData = useMemo(() => { const m={}; filtered.filter(t=>t.type==='expense').forEach(t=>{m[t.category]=(m[t.category]||0)+Number(t.amount)}); return Object.entries(m).map(([name,value])=>({name,value})).sort((a,b)=>b.value-a.value).slice(0,5); }, [filtered]);

      return (
        <div className="space-y-6 animate-slide-up">
          <div className="flex flex-col md:flex-row justify-between items-center gap-4"><MonthSelector currentDate={currentDate} onChange={setCurrentDate} /></div>
          <div className="grid grid-cols-1 md:grid-cols-3 gap-6">
            <Card className="!bg-gradient-to-br from-violet-600/90 to-indigo-800/90 !border-0 text-white relative overflow-visible"><div className="absolute top-0 right-0 w-32 h-32 bg-white/10 rounded-full blur-3xl -translate-y-1/2 translate-x-1/2"></div><div className="relative z-10"><p className="text-violet-200 font-medium text-sm">Saldo Acumulado</p><h2 className={`text-4xl font-extrabold tracking-tight my-4 ${privacyMode?'blur-md':''}`}>{formatCurrency(total, privacyMode)}</h2><div className="bg-black/20 rounded-2xl p-4 backdrop-blur-sm border border-white/5 space-y-2"><div className="flex justify-between text-sm"><span className="text-violet-200">Anterior</span><span className={`font-bold ${privacyMode?'blur-sm':''}`}>{formatCurrency(prevBal, privacyMode)}</span></div><div className="h-px bg-white/10"></div><div className="flex justify-between text-sm"><span className="text-violet-200">Mês Atual</span><span className={`font-bold ${balance>=0?'text-emerald-300':'text-rose-300'} ${privacyMode?'blur-sm':''}`}>{balance>0?'+':''}{formatCurrency(balance, privacyMode)}</span></div></div></div></Card>
            <Card><div className="flex justify-between mb-2"><span className="text-slate-400 text-sm font-bold uppercase">Entradas</span><ArrowUpRight className="text-emerald-500"/></div><h2 className={`text-3xl font-bold text-slate-800 dark:text-white ${privacyMode?'blur-md':''}`}>{formatCurrency(inc, privacyMode)}</h2></Card>
            <Card><div className="flex justify-between mb-2"><span className="text-slate-400 text-sm font-bold uppercase">Saídas</span><ArrowDownRight className="text-rose-500"/></div><h2 className={`text-3xl font-bold text-slate-800 dark:text-white ${privacyMode?'blur-md':''}`}>{formatCurrency(exp, privacyMode)}</h2></Card>
          </div>
          <div className="grid grid-cols-1 lg:grid-cols-3 gap-6">
            <Card className="lg:col-span-2 min-h-[350px]"><h3 className="text-lg font-bold text-white mb-6">Fluxo Diário</h3><div className={`h-[250px] w-full ${privacyMode?'opacity-20 blur-sm':''}`}><ResponsiveContainer width="100%" height="100%"><AreaChart data={areaData}><defs><linearGradient id="cInc" x1="0" y1="0" x2="0" y2="1"><stop offset="5%" stopColor="#10B981" stopOpacity={0.3}/><stop offset="95%" stopColor="#10B981" stopOpacity={0}/></linearGradient><linearGradient id="cExp" x1="0" y1="0" x2="0" y2="1"><stop offset="5%" stopColor="#F43F5E" stopOpacity={0.3}/><stop offset="95%" stopColor="#F43F5E" stopOpacity={0}/></linearGradient></defs><CartesianGrid strokeDasharray="3 3" vertical={false} stroke="#333"/><XAxis dataKey="name" stroke="#666" tickLine={false} axisLine={false}/><Tooltip contentStyle={{background:'#18181b', border:'none', borderRadius:'12px', color:'#fff'}}/><Area type="monotone" dataKey="Entradas" stroke="#10B981" fill="url(#cInc)" strokeWidth={3}/><Area type="monotone" dataKey="Saídas" stroke="#F43F5E" fill="url(#cExp)" strokeWidth={3}/></AreaChart></ResponsiveContainer></div></Card>
            <Card className="min-h-[350px] flex flex-col"><h3 className="text-lg font-bold text-white mb-6">Top Despesas</h3><div className="flex-1 flex items-center justify-center relative">{catData.length>0?(<><div className="w-full h-48 absolute inset-0"><ResponsiveContainer><PieChart><Pie data={catData} cx="50%" cy="50%" innerRadius={50} outerRadius={70} paddingAngle={5} dataKey="value" stroke="none">{catData.map((e,i)=><Cell key={i} fill={CATEGORY_COLORS[e.name]||'#666'}/>)}</Pie></PieChart></ResponsiveContainer></div><div className="w-full mt-48 space-y-2">{catData.map((e,i)=>(<div key={i} className="flex justify-between text-sm"><div className="flex items-center gap-2"><div className="w-2 h-2 rounded-full" style={{backgroundColor:CATEGORY_COLORS[e.name]}}></div><span className="text-slate-300">{e.name}</span></div><span className="font-bold text-white">{formatCurrency(e.value)}</span></div>))}</div></>):(<p className="text-slate-500 text-sm">Sem dados</p>)}</div></Card>
          </div>
        </div>
      );
    };

    const TransactionsView = ({ transactions=[], onDelete, onEdit }) => {
        const [filter, setFilter] = useState('');
        const safe = Array.isArray(transactions) ? transactions : [];
        const filtered = safe.filter(t=>t.description.toLowerCase().includes(filter.toLowerCase()));
        return (
            <div className="space-y-6 animate-fade-in">
                <div className="flex justify-between gap-4"><div className="relative flex-1"><Search size={18} className="absolute left-4 top-3.5 text-slate-400"/><input type="text" placeholder="Buscar..." value={filter} onChange={e=>setFilter(e.target.value)} className={`${theme.input} !pl-12`}/></div></div>
                <Card className="!p-0 overflow-hidden"><div className="overflow-x-auto"><table className="w-full text-left text-sm text-slate-400"><thead className="bg-white/5 text-xs uppercase text-slate-300"><tr><th className="p-4">Descrição</th><th className="p-4">Categoria</th><th className="p-4 text-right">Valor</th><th className="p-4 text-center">Data</th><th className="p-4 text-center">Ação</th></tr></thead><tbody className="divide-y divide-white/5">{filtered.map(t=>(<tr key={t.id} className="hover:bg-white/5"><td className="p-4 font-medium text-white">{t.description}{t.isRecurring&&<span className="text-[10px] text-violet-500 ml-2">Recurring</span>}</td><td className="p-4"><span className="px-2 py-1 rounded text-xs bg-white/10 text-white">{t.category}</span></td><td className={`p-4 text-right font-bold ${t.type==='income'?'text-emerald-400':'text-rose-400'}`}>{t.type==='income'?'+':'-'} {formatCurrency(t.amount)}</td><td className="p-4 text-center">{formatDate(t.date)}</td><td className="p-4 text-center flex justify-center gap-2"><button onClick={()=>onEdit(t)} className="text-blue-400"><Edit2 size={16}/></button><button onClick={()=>onDelete(t.id)} className="text-rose-400"><Trash2 size={16}/></button></td></tr>))}</tbody></table></div></Card>
            </div>
        );
    };

    const GoalsView = ({ goals=[], onRefresh, onDelete, privacyMode }) => {
        const [isAdding, setIsAdding] = useState(false); const [editing, setEditing] = useState(null); const [depositing, setDepositing] = useState(null);
        const handleSave = async (e) => { e.preventDefault(); const fd=new FormData(e.target); const body={name:fd.get('name'), target:Number(fd.get('target')), current:Number(fd.get('current')), color:fd.get('color')}; try { await fetch(editing?`/api/goals/${editing.id}`:'/api/goals', {method:editing?'PUT':'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify(body)}); onRefresh(); setIsAdding(false); setEditing(null); } catch(e){} };
        const handleDeposit = async (e) => { e.preventDefault(); const val=Number(new FormData(e.target).get('amount')); if(val>0){ await fetch(`/api/goals/${depositing.id}`, {method:'PUT', headers:{'Content-Type':'application/json'}, body:JSON.stringify({...depositing, current:depositing.current+val})}); onRefresh(); setDepositing(null); } };
        return (
            <div className="space-y-8 animate-fade-in"><div className="flex justify-between items-end"><div><h2 className="text-xl font-bold text-white flex gap-2"><Target className="text-violet-500"/> Objetivos</h2></div><button onClick={()=>setIsAdding(true)} className={theme.btnAccent}><Plus size={18}/> Nova Meta</button></div>
            <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">{goals.map(g=>{ const pct=Math.min((g.current/g.target)*100,100); return (<div key={g.id} className="group relative bg-[#18181b] border border-white/5 rounded-[24px] p-5 hover:border-violet-500/30 transition-all"><div className="flex justify-between mb-4"><div className="flex items-center gap-3"><div className="w-10 h-10 rounded-xl flex items-center justify-center text-white shadow-lg" style={{backgroundColor:g.color}}><Target size={20}/></div><div><h3 className="font-bold text-white">{g.name}</h3><p className={`text-xs text-slate-500 ${privacyMode?'blur-sm':''}`}>Meta: {formatCurrency(g.target)}</p></div></div><div className="flex gap-2"><button onClick={()=>setEditing(g)} className="p-1.5 text-slate-400 hover:text-blue-400"><Edit2 size={16}/></button><button onClick={()=>onDelete(g.id)} className="p-1.5 text-slate-400 hover:text-rose-400"><Trash2 size={16}/></button></div></div><div className="space-y-1 mb-4"><div className="flex justify-between items-end"><p className="text-sm text-slate-400">Progresso</p><span className="text-xs font-bold text-white">{pct.toFixed(0)}%</span></div><div className="relative h-2 w-full bg-white/5 rounded-full overflow-hidden"><div className="absolute top-0 left-0 h-full rounded-full transition-all" style={{width:`${pct}%`, backgroundColor:g.color}}></div></div></div><button onClick={()=>setDepositing(g)} className="w-full py-2 bg-white/5 rounded-xl text-white hover:bg-white/10 text-sm font-bold flex items-center justify-center gap-2"><Plus size={14}/> Depositar</button></div>)})}</div>
            {(isAdding||editing)&&<Modal isOpen={true} onClose={()=>{setIsAdding(false);setEditing(null)}} title={editing?"Editar":"Nova Meta"}><form onSubmit={handleSave} className="space-y-4"><div><label className={theme.label}>Nome</label><input name="name" defaultValue={editing?.name} className={theme.input} required/></div><div className="grid grid-cols-2 gap-4"><div><label className={theme.label}>Meta</label><input name="target" type="number" defaultValue={editing?.target} className={theme.input} required/></div><div><label className={theme.label}>Atual</label><input name="current" type="number" defaultValue={editing?.current||0} className={theme.input} required/></div></div><div><label className={theme.label}>Cor</label><div className="flex gap-2"><input type="radio" name="color" value="#8b5cf6" defaultChecked/><input type="radio" name="color" value="#ec4899"/><input type="radio" name="color" value="#10b981"/></div></div><button className={theme.btnPrimary}>Salvar</button></form></Modal>}
            {depositing&&<Modal isOpen={true} onClose={()=>setDepositing(null)} title="Depositar"><form onSubmit={handleDeposit} className="space-y-4"><div><label className={theme.label}>Valor</label><input name="amount" type="number" className={theme.input} autoFocus/></div><button className={theme.btnPrimary}>Confirmar</button></form></Modal>}
            </div>
        );
    };

    // --- APP ---
    function App() {
        const [authMode, setAuthMode] = useState('loading');
        const [user, setUser] = useState(null);
        const [activeTab, setActiveTab] = useState('overview');
        const [toasts, setToasts] = useState([]);
        const [modals, setModals] = useState({});
        
        // Data States
        const [transactions, setTransactions] = useState([]);
        const [goals, setGoals] = useState([]);
        const [cards, setCards] = useState([]);
        const [investments, setInvestments] = useState([]);
        const [budgets, setBudgets] = useState([]);
        const [privacyMode, setPrivacyMode] = useState(false);

        // Edit/Add States
        const [transType, setTransType] = useState('expense');
        const [transCat, setTransCat] = useState('Moradia');
        const [editingTransaction, setEditingTransaction] = useState(null);
        const [prefilledDate, setPrefilledDate] = useState(new Date().toISOString().split('T')[0]);
        const [selectedDateDetails, setSelectedDateDetails] = useState(null);

        const addToast = (msg, type='success') => { const id=Date.now(); setToasts(p=>[...p,{id,msg,type}]); setTimeout(()=>setToasts(p=>p.filter(t=>t.id!==id)),3000); };
        const toggleModal = (k,v) => setModals(p=>({...p,[k]:v}));

        const fetchAll = async () => {
            try {
                const [t,g,c,i,b] = await Promise.all([
                    fetch('/api/transactions').then(r=>r.ok?r.json():[]),
                    fetch('/api/goals').then(r=>r.ok?r.json():[]),
                    fetch('/api/cards').then(r=>r.ok?r.json():[]),
                    fetch('/api/investments').then(r=>r.ok?r.json():[]),
                    fetch('/api/budgets').then(r=>r.ok?r.json():[])
                ]);
                setTransactions(Array.isArray(t)?t:[]);
                setGoals(Array.isArray(g)?g:[]);
                setCards(Array.isArray(c)?c:[]);
                setInvestments(Array.isArray(i)?i:[]);
                setBudgets(Array.isArray(b)?b:[]);
            } catch(e) { console.error(e); }
        };

        useEffect(() => {
            const saved = localStorage.getItem('prospera_keep_login');
            if (saved) { setUser(JSON.parse(saved)); setAuthMode('app'); fetchAll(); }
            else { setAuthMode('login'); }
        }, []);

        const handleLogin = async (pin, keep, setError) => {
            try { const res = await fetch('/api/auth/login', {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({pin})}); const d=await res.json();
            if(d.success) { if(keep) localStorage.setItem('prospera_keep_login', JSON.stringify(d.user)); setUser(d.user); setAuthMode('app'); fetchAll(); } else setError(d.error); } catch { setError("Erro"); }
        };
        const handleRegister = async (data, setError, onSuccess) => {
            try { const res = await fetch('/api/auth/register', {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify(data)}); const d=await res.json();
            if(d.success) onSuccess(); else setError(d.error); } catch { setError("Erro"); }
        };
        const handleRecover = async (data, setError, onSuccess) => {
            try { const res = await fetch('/api/auth/reset', {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({name:data.name, answer:data.answer, newPin:data.pin})}); const d=await res.json();
            if(d.success) onSuccess(); else setError(d.error); } catch { setError("Erro"); }
        };
        const handleLogout = () => { localStorage.removeItem('prospera_keep_login'); setUser(null); setAuthMode('login'); };

        const handleAddTrans = async (e) => {
            e.preventDefault(); const fd=new FormData(e.target);
            const body = { description:fd.get('description'), amount:Number(fd.get('amount')), type:fd.get('type'), category:transCat, subcategory:fd.get('subcategory'), date:fd.get('date'), paymentMethod:fd.get('paymentMethod'), isRecurring:fd.get('isRecurring')==='on', cardId:fd.get('cardId') };
            const url = editingTransaction ? `/api/transactions/${editingTransaction.id}` : '/api/transactions'; // Note: Server needs PUT for update, assuming delete+post for now or update server.js later.
            // Simplified: Always create new for now based on previous server code, or handle edit.
            // Since previous server.js didn't have PUT for transactions, we'll assume create only or delete+create logic if complex. 
            // For now, let's just create.
            await fetch('/api/transactions', {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify(body)});
            addToast("Salvo!"); fetchAll(); toggleModal('transaction', false); setEditingTransaction(null);
        };
        const deleteItem = async (type, id) => { await fetch(`/api/${type}/${id}`, {method:'DELETE'}); addToast("Excluído"); fetchAll(); };

        if (authMode === 'loading') return <div className="min-h-screen bg-[#050505] flex items-center justify-center"><div className="animate-spin rounded-full h-12 w-12 border-t-2 border-b-2 border-violet-500"></div></div>;
        if (authMode !== 'app') return <AuthScreen onLogin={handleLogin} onRegister={handleRegister} onRecover={handleRecover} />;

        const navItems = [ { id: 'overview', label: 'Dashboard', icon: LayoutDashboard }, { id: 'transactions', label: 'Extrato', icon: ListFilter }, { id: 'goals', label: 'Objetivos', icon: Target }, { id: 'budgets', label: 'Orçamentos', icon: PiggyBank }, { id: 'investments', label: 'Carteira', icon: TrendingUp }, { id: 'recurring', label: 'Recorrência', icon: Repeat }, { id: 'calculator', label: 'Calculadora', icon: Calculator } ];

        return (
            <div className="flex flex-col md:flex-row h-screen bg-slate-50 dark:bg-[#050505] overflow-hidden text-slate-900 dark:text-white">
                <aside className="w-24 hidden md:flex flex-col items-center py-8 z-30 h-full border-r border-slate-200 dark:border-white/5 bg-white/50 dark:bg-[#09090b]/50 backdrop-blur-sm">
                    <div className="mb-8 scale-75"><CustomLogo /></div>
                    <div className="flex-1 flex flex-col gap-4 w-full px-4">{navItems.map(i => (<button key={i.id} onClick={() => setActiveTab(i.id)} className={`w-full aspect-square rounded-2xl flex flex-col items-center justify-center gap-1 transition-all ${activeTab===i.id?'bg-white/10':''}`}><i.icon size={22}/><span className="text-[9px]">{i.label}</span></button>))}</div>
                    <div className="flex flex-col gap-4 px-4 pb-4"><button onClick={() => setPrivacyMode(!privacyMode)} className="w-full aspect-square rounded-2xl bg-white/5 flex items-center justify-center">{privacyMode?<EyeOff/>:<Eye/>}</button><button onClick={handleLogout} className="w-full aspect-square rounded-2xl bg-rose-500/10 text-rose-500 flex items-center justify-center"><LogOut/></button></div>
                </aside>
                <main className="flex-1 overflow-y-auto relative z-20 pb-24 md:pb-0 pt-safe">
                    <div className="max-w-7xl mx-auto p-6 md:p-10">
                        <header className="flex justify-between items-center mb-10"><div><h1 className="text-3xl font-extrabold mb-1">Olá, {user?.name}</h1><p className="text-slate-500">Bem-vindo de volta.</p></div><div className="flex gap-3">{activeTab==='overview'&&<button onClick={()=>{setEditingTransaction(null);toggleModal('transaction',true)}} className={theme.btnAccent}><Plus size={18}/> Transação</button>}</div></header>
                        
                        {activeTab === 'overview' && <Overview transactions={transactions} goals={goals} privacyMode={privacyMode} toggleModal={toggleModal} setPrefilledDate={setPrefilledDate} user={user} />}
                        {activeTab === 'transactions' && <TransactionsView transactions={transactions} onDelete={(id) => deleteItem('transactions', id)} onEdit={(t)=>{setEditingTransaction(t);toggleModal('transaction',true)}} />}
                        {activeTab === 'goals' && <GoalsView goals={goals} onRefresh={fetchAll} onDelete={(id) => deleteItem('goals', id)} privacyMode={privacyMode} />}
                        {activeTab === 'budgets' && <BudgetView transactions={transactions} budgets={budgets} setBudgets={setBudgets} onRefresh={fetchAll} privacyMode={privacyMode} />}
                        {activeTab === 'investments' && <InvestmentsView investments={investments} cards={cards} onAddCard={async(d)=>{await fetch('/api/cards',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(d)});fetchAll()}} onUpdateCard={async(d)=>{await fetch(`/api/cards/${d.id}`,{method:'PUT',headers:{'Content-Type':'application/json'},body:JSON.stringify(d)});fetchAll()}} onDeleteCard={(id)=>deleteItem('cards',id)} onAddInvest={async(d)=>{await fetch('/api/investments',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(d)});fetchAll()}} onUpdateInvest={async(d)=>{await fetch(`/api/investments/${d.id}`,{method:'PUT',headers:{'Content-Type':'application/json'},body:JSON.stringify(d)});fetchAll()}} onDeleteInvest={(id)=>deleteItem('investments',id)} privacyMode={privacyMode} />}
                        {activeTab === 'recurring' && <RecurringView transactions={transactions} cards={cards} onDelete={(id) => deleteItem('transactions', id)} onEdit={(t)=>{setEditingTransaction(t);toggleModal('transaction',true)}} onAdd={()=>{toggleModal('subscription',true)}} privacyMode={privacyMode} />}
                        {activeTab === 'calculator' && <CalculatorView />}
                        {activeTab === 'calendar' && <CalendarView transactions={transactions} onDayClick={(date, ts) => { setSelectedDateDetails({date, transactions:ts}); toggleModal('dayDetails', true); }} />}
                    </div>
                </main>
                <div className="md:hidden fixed bottom-0 w-full bg-[#09090b]/90 backdrop-blur-xl border-t border-white/5 flex justify-between px-6 py-4 z-50">{navItems.slice(0,4).map(i=><button key={i.id} onClick={()=>setActiveTab(i.id)} className={`${activeTab===i.id?'text-violet-500':'text-slate-500'}`}><i.icon/></button>)}</div>
                <ToastContainer toasts={toasts} />
                
                {/* MODALS */}
                <Modal isOpen={modals.transaction} onClose={() => toggleModal('transaction', false)} title={editingTransaction?"Editar":"Nova Transação"}>
                    <form onSubmit={handleAddTrans} className="space-y-4">
                        <div className="grid grid-cols-2 gap-4">
                            <div><label className={theme.label}>Tipo</label><select name="type" className={theme.input} defaultValue={editingTransaction?.type||transType} onChange={e => {setTransType(e.target.value); setTransCat(Object.keys(CATEGORIES[e.target.value])[0])}}><option value="expense">Saída</option><option value="income">Entrada</option></select></div>
                            <div><label className={theme.label}>Valor</label><input name="amount" type="number" step="0.01" defaultValue={editingTransaction?.amount} className={theme.input} required /></div>
                        </div>
                        <div><label className={theme.label}>Descrição</label><input name="description" defaultValue={editingTransaction?.description} className={theme.input} required /></div>
                        <div className="grid grid-cols-2 gap-4">
                            <div><label className={theme.label}>Categoria</label><select name="category" defaultValue={editingTransaction?.category||transCat} className={theme.input} onChange={e => setTransCat(e.target.value)}>{Object.keys(CATEGORIES[transType]).map(c=><option key={c} value={c}>{c}</option>)}</select></div>
                            <div><label className={theme.label}>Data</label><input name="date" type="date" defaultValue={editingTransaction?.date||prefilledDate} className={theme.input} required /></div>
                        </div>
                        <div className="flex items-center gap-2"><input type="checkbox" name="isRecurring" defaultChecked={editingTransaction?.isRecurring} className="accent-violet-500"/><label className="text-sm text-slate-400">Recorrente</label></div>
                        <button className={theme.btnPrimary}>Salvar</button>
                    </form>
                </Modal>
                <DayDetailsModal isOpen={modals.dayDetails} onClose={() => toggleModal('dayDetails', false)} date={selectedDateDetails?.date} transactions={selectedDateDetails?.transactions || []} onDelete={(id) => deleteItem('transactions', id)} onAdd={() => { setPrefilledDate(selectedDateDetails.date); toggleModal('dayDetails', false); toggleModal('transaction', true); }} onEdit={(t) => { toggleModal('dayDetails', false); setEditingTransaction(t); toggleModal('transaction', true); }} />
                <SettingsModal isOpen={modals.settings} onClose={() => toggleModal('settings', false)} onLogout={handleLogout} />
            </div>
        );
    }

    const root = createRoot(document.getElementById('root'));
    root.render(<App />);
  </script>
</body>
</html>
