<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
  <title>Prospera - Gestão Inteligente</title>
  
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      darkMode: 'class',
      theme: {
        extend: {
          fontFamily: { sans: ['Outfit', 'sans-serif'], body: ['Inter', 'sans-serif'] },
          colors: { background: '#09090b', surface: '#18181b', primary: '#8b5cf6', secondary: '#ec4899', accent: '#06b6d4', gold: '#fbbf24' },
          animation: { 'fade-in': 'fadeIn 0.4s cubic-bezier(0.16, 1, 0.3, 1)', 'slide-up': 'slideUp 0.5s cubic-bezier(0.16, 1, 0.3, 1)' },
          keyframes: { fadeIn: { '0%': { opacity: '0' }, '100%': { opacity: '1' } }, slideUp: { '0%': { transform: 'translateY(20px)', opacity: '0' }, '100%': { transform: 'translateY(0)', opacity: '1' } } }
        }
      }
    }
  </script>
  
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700;800&family=Inter:wght@300;400;500;600&display=swap" rel="stylesheet">

  <script type="importmap">
    {
      "imports": {
        "react": "https://esm.sh/react@18.2.0",
        "react-dom": "https://esm.sh/react-dom@18.2.0",
        "react-dom/client": "https://esm.sh/react-dom@18.2.0/client",
        "recharts": "https://esm.sh/recharts@2.12.0?external=react,react-dom",
        "lucide-react": "https://esm.sh/lucide-react@0.300.0?external=react,react-dom"
      }
    }
  </script>

  <style>
    body { font-family: 'Inter', sans-serif; -webkit-tap-highlight-color: transparent; }
    h1, h2, h3, h4, button, .font-heading { font-family: 'Outfit', sans-serif; }
    ::-webkit-scrollbar { width: 6px; height: 6px; } ::-webkit-scrollbar-track { background: transparent; } ::-webkit-scrollbar-thumb { background: #3f3f46; border-radius: 10px; }
    .glass { background: rgba(255, 255, 255, 0.03); backdrop-filter: blur(16px); -webkit-backdrop-filter: blur(16px); border: 1px solid rgba(255, 255, 255, 0.08); }
    .bg-gradient-animate { background: radial-gradient(circle at 50% 0%, rgba(139, 92, 246, 0.15), transparent 40%), radial-gradient(circle at 80% 50%, rgba(6, 182, 212, 0.1), transparent 40%); }
    select { color-scheme: dark; } option { background-color: #18181b !important; color: #ffffff !important; padding: 10px; }
    .pb-safe { padding-bottom: env(safe-area-inset-bottom); } .pt-safe { padding-top: env(safe-area-inset-top); }
    .no-scrollbar::-webkit-scrollbar { display: none; } .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
  </style>
</head>
<body class="bg-slate-50 dark:bg-[#09090b] text-slate-900 dark:text-slate-100 transition-colors duration-500 min-h-screen selection:bg-violet-500/30 overflow-hidden">
  <div id="root"></div>

  <script type="text/babel" data-type="module">
    import React, { useState, useEffect, useMemo } from 'react';
    import { createRoot } from 'react-dom/client';
    import { PieChart, Pie, Cell, AreaChart, Area, XAxis, YAxis, CartesianGrid, Tooltip as RechartsTooltip, ResponsiveContainer } from 'recharts';
    import { Wallet, TrendingUp, TrendingDown, Target, CreditCard, DollarSign, Menu, X, Plus, ArrowUpRight, ArrowDownRight, LayoutDashboard, ListFilter, Trash2, Calendar as CalendarIcon, Save, Moon, Sun, Download, Upload, RefreshCw, AlertCircle, Coins, Calculator, PiggyBank, Edit2, Lock, Unlock, Eye, EyeOff, ShieldCheck, LogOut, Gem, Activity, Landmark, CalendarDays, Sprout, MoreHorizontal, ChevronLeft, ChevronRight, Repeat, Search, Filter, ArrowUp, ArrowDown, CheckCircle, XCircle, ArrowUpDown, Trophy, Building2, Briefcase, CalendarClock } from 'lucide-react';

    // CONSTANTES
    const CATEGORIES = { expense: { 'Moradia': [], 'Alimentação': [], 'Transporte': [], 'Lazer': [], 'Pessoal': [], 'Serviços': [], 'Outros': [] }, income: { 'Salário': [], 'Extra': [] } };
    const CATEGORY_COLORS = { 'Moradia': '#8b5cf6', 'Alimentação': '#f59e0b', 'Transporte': '#ef4444', 'Lazer': '#06b6d4', 'Pessoal': '#ec4899', 'Serviços': '#6366f1', 'Outros': '#64748b', 'Salário': '#10b981', 'Extra': '#3b82f6' };
    const PAYMENT_METHODS = [ { id: 'pix', label: 'Pix' }, { id: 'money', label: 'Dinheiro' }, { id: 'debit', label: 'Débito' }, { id: 'credit_card', label: 'Cartão de Crédito' } ];
    const formatCurrency = (val, hid) => hid ? '••••' : new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' }).format(val || 0);
    const formatDate = (s) => s ? s.split('-').reverse().join('/') : '';

    const theme = {
      card: "glass rounded-[24px] md:rounded-[32px] p-5 md:p-6 relative overflow-hidden group",
      input: "w-full rounded-xl border-0 bg-white dark:bg-[#18181b] border border-slate-200 dark:border-white/10 px-4 py-3.5 text-slate-900 dark:text-white outline-none ring-1 ring-transparent focus:ring-violet-500/50 transition-all font-medium shadow-sm",
      label: "mb-1.5 block text-xs font-bold uppercase tracking-widest text-slate-500 dark:text-slate-400 ml-1",
      btnPrimary: "flex items-center justify-center gap-2 rounded-2xl bg-white dark:bg-white text-slate-900 py-3.5 px-5 font-bold shadow-xl shadow-white/10 transition-all hover:scale-[1.02] active:scale-[0.98] cursor-pointer w-full",
      btnAccent: "flex items-center justify-center gap-2 rounded-xl bg-violet-600 text-white py-3 px-4 font-bold shadow-xl shadow-violet-600/20 transition-all hover:bg-violet-500 hover:scale-[1.02] active:scale-[0.98] cursor-pointer",
    };

    // COMPONENTS
    const Modal = ({ isOpen, onClose, title, children }) => {
      useEffect(() => { const h = (e) => { if (e.key === 'Escape') onClose(); }; if(isOpen) window.addEventListener('keydown', h); return () => window.removeEventListener('keydown', h); }, [isOpen, onClose]);
      if (!isOpen) return null;
      return (<div className="fixed inset-0 z-[60] flex items-center justify-center bg-black/90 backdrop-blur-md p-4 animate-fade-in" onClick={(e)=>e.target===e.currentTarget&&onClose()}><div className="w-full max-w-lg bg-[#0f172a] border border-slate-800 rounded-[24px] shadow-2xl animate-slide-up flex flex-col max-h-[90vh]"><div className="p-5 border-b border-white/5 flex justify-between items-center"><h3 className="text-xl font-bold text-white">{title}</h3><button onClick={onClose} className="p-2 text-slate-400 hover:text-white"><X size={20}/></button></div><div className="overflow-y-auto p-5 custom-scrollbar">{children}</div></div></div>);
    };
    const Card = ({ children, className = "" }) => <div className={`${theme.card} ${className}`}>{children}</div>;
    const CustomLogo = () => (<div className="w-16 h-16 bg-gradient-to-tr from-emerald-500 to-green-600 rounded-2xl flex items-center justify-center shadow-lg mb-8 shrink-0"><Sprout className="text-white" size={32} /></div>);
    const ToastContainer = ({ toasts }) => (<div className="fixed bottom-10 right-10 z-[100] flex flex-col gap-3 pointer-events-none">{toasts.map(t=><div key={t.id} className={`pointer-events-auto flex items-center gap-3 px-5 py-4 rounded-xl shadow-2xl border border-white/10 text-white font-medium animate-slide-in-right ${t.type==='error'?'bg-rose-600':'bg-[#18181b]'}`}>{t.type==='success'?<CheckCircle size={20} className="text-emerald-400"/>:<XCircle size={20} className="text-white"/>}<span>{t.msg}</span></div>)}</div>);
    const MonthSelector = ({ currentDate, onChange }) => (<div className="flex items-center gap-2 bg-slate-200 dark:bg-[#18181b] p-1 rounded-xl border border-slate-300 dark:border-white/5"><button onClick={()=>onChange(new Date(currentDate.getFullYear(), currentDate.getMonth()-1, 1))} className="p-1.5 hover:text-white"><ChevronLeft size={18}/></button><span className="text-sm font-bold capitalize min-w-[100px] text-center">{currentDate.toLocaleDateString('pt-BR',{month:'long',year:'numeric'})}</span><button onClick={()=>onChange(new Date(currentDate.getFullYear(), currentDate.getMonth()+1, 1))} className="p-1.5 hover:text-white"><ChevronRight size={18}/></button></div>);

    // AUTH SCREEN
    const AuthScreen = ({ onLogin, onRegister, onRecover }) => {
        const [mode, setMode] = useState('login'); 
        const [formData, setFormData] = useState({ name: '', pin: '', confirmPin: '', question: 'Qual o nome do seu primeiro animal de estimação?', answer: '' });
        const [keepLogged, setKeepLogged] = useState(false);
        const [error, setError] = useState('');
        const [success, setSuccess] = useState('');

        const handleChange = (e) => setFormData({...formData, [e.target.name]: e.target.value});

        const handleSubmit = (e) => {
            e.preventDefault(); setError(''); setSuccess('');
            if(mode === 'login') {
                onLogin(formData.pin, keepLogged, setError);
            } else if (mode === 'register') {
                if(formData.pin !== formData.confirmPin) return setError('PINs não conferem');
                if(formData.pin.length < 4) return setError('Mínimo 4 dígitos');
                onRegister(formData, setError, () => { setSuccess('Conta criada! Faça login.'); setMode('login'); });
            } else {
                onRecover(formData, setError, () => { setSuccess('Senha alterada! Faça login.'); setMode('login'); });
            }
        };

        return (
            <div className="min-h-screen flex items-center justify-center p-4 bg-[#050505] relative overflow-hidden">
                <div className="absolute w-[800px] h-[800px] bg-violet-600/20 rounded-full blur-[120px] animate-pulse-slow"></div>
                <div className="w-full max-w-md bg-[#0f172a]/90 backdrop-blur-2xl border border-white/10 rounded-[32px] shadow-2xl p-10 relative z-10 animate-fade-in flex flex-col items-center">
                    <CustomLogo />
                    <h1 className="text-3xl font-extrabold text-white mb-2">Prospera</h1>
                    <p className="text-slate-400 font-medium mb-8">O cofre do seu futuro</p>
                    <form onSubmit={handleSubmit} className="w-full space-y-4">
                        {(mode === 'register' || mode === 'recover') && (<div><label className={theme.label}>Seu Nome</label><input name="name" value={formData.name} onChange={handleChange} className={theme.input} placeholder="Ex: Eduardo" autoFocus /></div>)}
                        {mode === 'register' && (<div><label className={theme.label}>Pergunta Secreta</label><select name="question" value={formData.question} onChange={handleChange} className={theme.input}><option>Qual o nome do seu primeiro animal de estimação?</option><option>Qual a cidade onde você nasceu?</option><option>Qual sua comida favorita?</option></select></div>)}
                        {(mode === 'register' || mode === 'recover') && (<div><label className={theme.label}>Resposta Secreta</label><input name="answer" value={formData.answer} onChange={handleChange} className={theme.input} placeholder="Sua resposta" /></div>)}
                        <div><label className={theme.label}>{mode === 'recover' ? 'Novo PIN' : 'Código PIN'}</label><input type="password" inputMode="numeric" name="pin" value={formData.pin} onChange={handleChange} className={`${theme.input} text-center text-2xl tracking-widest`} placeholder="••••" maxLength={6} /></div>
                        {mode === 'register' && (<div><label className={theme.label}>Confirmar PIN</label><input type="password" inputMode="numeric" name="confirmPin" value={formData.confirmPin} onChange={handleChange} className={`${theme.input} text-center text-2xl tracking-widest`} placeholder="••••" maxLength={6} /></div>)}
                        {mode === 'login' && (<div className="flex items-center gap-2 justify-center py-2"><input type="checkbox" id="keep" checked={keepLogged} onChange={e => setKeepLogged(e.target.checked)} className="w-4 h-4 accent-violet-600 rounded cursor-pointer" /><label htmlFor="keep" className="text-sm text-slate-400 cursor-pointer">Manter conectado</label></div>)}
                        {error && <div className="text-rose-400 text-sm text-center bg-rose-500/10 p-3 rounded-xl border border-rose-500/20">{error}</div>}
                        {success && <div className="text-emerald-400 text-sm text-center bg-emerald-500/10 p-3 rounded-xl border border-emerald-500/20">{success}</div>}
                        <button type="submit" className={theme.btnPrimary}>{mode === 'login' ? 'Entrar' : mode === 'register' ? 'Criar Conta' : 'Redefinir Senha'}</button>
                    </form>
                    <div className="mt-6 flex flex-col gap-2 text-sm text-center">
                        {mode === 'login' && (<><button onClick={() => setMode('recover')} className="text-slate-400 hover:text-white">Esqueci meu PIN</button><span className="mx-2 text-slate-600">|</span><button onClick={() => setMode('register')} className="text-violet-400 hover:text-violet-300 font-bold">Criar uma conta</button></>)}
                        {mode !== 'login' && (<button onClick={() => setMode('login')} className="text-slate-400 hover:text-white">Voltar para Login</button>)}
                    </div>
                </div>
            </div>
        );
    };

    // --- VIEWS ---
    const Overview = ({ transactions = [], privacyMode }) => {
      const [currentDate, setCurrentDate] = useState(new Date());
      // Segurança: Verifica se é array antes de filtrar
      const safeTrans = Array.isArray(transactions) ? transactions : [];
      
      const filtered = useMemo(() => safeTrans.filter(t => { 
          const tDate = new Date(t.date); 
          const adj = new Date(tDate.getTime() + tDate.getTimezoneOffset() * 60000); 
          return adj.getMonth() === currentDate.getMonth() && adj.getFullYear() === currentDate.getFullYear(); 
      }), [safeTrans, currentDate]);

      const income = filtered.filter(t => t.type === 'income').reduce((a, t) => a + Number(t.amount), 0);
      const expense = filtered.filter(t => t.type === 'expense').reduce((a, t) => a + Number(t.amount), 0);
      const balance = income - expense;

      // Cálculo do saldo acumulado (tudo antes do mês atual)
      const prevBalance = useMemo(() => {
          const start = new Date(currentDate.getFullYear(), currentDate.getMonth(), 1);
          start.setHours(0,0,0,0);
          return safeTrans.filter(t => {
             const tDate = new Date(t.date);
             const adj = new Date(tDate.getTime() + tDate.getTimezoneOffset() * 60000);
             return adj < start;
          }).reduce((acc, t) => acc + (t.type === 'income' ? Number(t.amount) : -Number(t.amount)), 0);
      }, [safeTrans, currentDate]);

      const totalBalance = prevBalance + balance;

      return (
        <div className="space-y-6 animate-slide-up">
          <div className="flex flex-col md:flex-row justify-between items-center gap-4"><MonthSelector currentDate={currentDate} onChange={setCurrentDate} /></div>
          <div className="grid grid-cols-1 md:grid-cols-3 gap-6">
            <Card className="!bg-gradient-to-br from-violet-600/90 to-indigo-800/90 !border-0 text-white"><p className="text-violet-200 text-sm font-medium mb-1">Saldo Atual</p><h2 className={`text-4xl font-extrabold tracking-tight ${privacyMode ? 'blur-md' : ''}`}>{formatCurrency(totalBalance, privacyMode)}</h2><div className="mt-4 pt-4 border-t border-white/10 flex justify-between text-sm"><span className="text-violet-200">Mês Atual</span><span className="font-bold">{balance > 0 ? '+' : ''}{formatCurrency(balance, privacyMode)}</span></div></Card>
            <Card><div className="flex justify-between mb-2"><span className="text-slate-400 text-sm font-bold uppercase">Entradas</span><ArrowUpRight className="text-emerald-500"/></div><h2 className={`text-3xl font-bold text-slate-800 dark:text-white ${privacyMode ? 'blur-md' : ''}`}>{formatCurrency(income, privacyMode)}</h2></Card>
            <Card><div className="flex justify-between mb-2"><span className="text-slate-400 text-sm font-bold uppercase">Saídas</span><ArrowDownRight className="text-rose-500"/></div><h2 className={`text-3xl font-bold text-slate-800 dark:text-white ${privacyMode ? 'blur-md' : ''}`}>{formatCurrency(expense, privacyMode)}</h2></Card>
          </div>
        </div>
      );
    };

    const TransactionsView = ({ transactions = [], onDelete }) => {
        const safeTrans = Array.isArray(transactions) ? transactions : [];
        return (
            <div className="space-y-4 animate-fade-in">
                <h2 className="text-xl font-bold text-white">Extrato Completo</h2>
                <div className="overflow-x-auto rounded-[24px] border border-white/5">
                    <table className="w-full text-left text-sm text-slate-400">
                        <thead className="bg-white/5 text-xs uppercase text-slate-300"><tr><th className="p-4">Descrição</th><th className="p-4">Categoria</th><th className="p-4 text-right">Valor</th><th className="p-4 text-center">Data</th><th className="p-4 text-center">Ação</th></tr></thead>
                        <tbody className="divide-y divide-white/5">
                            {safeTrans.map(t => (
                                <tr key={t.id} className="hover:bg-white/5 transition-colors">
                                    <td className="p-4 font-medium text-white">{t.description}</td>
                                    <td className="p-4"><span className="px-2 py-1 rounded text-xs bg-white/10 text-white">{t.category}</span></td>
                                    <td className={`p-4 text-right font-bold ${t.type==='income'?'text-emerald-400':'text-rose-400'}`}>{t.type==='income'?'+':'-'} {formatCurrency(t.amount, false)}</td>
                                    <td className="p-4 text-center">{formatDate(t.date)}</td>
                                    <td className="p-4 text-center"><button onClick={() => onDelete(t.id)} className="text-rose-400 hover:text-rose-300"><Trash2 size={16}/></button></td>
                                </tr>
                            ))}
                            {safeTrans.length === 0 && <tr><td colSpan="5" className="p-8 text-center text-slate-500">Nenhuma transação encontrada.</td></tr>}
                        </tbody>
                    </table>
                </div>
            </div>
        );
    };

    // --- APP ---
    function App() {
        const [authMode, setAuthMode] = useState('loading');
        const [user, setUser] = useState(null);
        const [activeTab, setActiveTab] = useState('overview');
        const [toasts, setToasts] = useState([]);
        const [modals, setModals] = useState({});
        
        const [transactions, setTransactions] = useState([]);
        const [goals, setGoals] = useState([]);
        const [cards, setCards] = useState([]);
        const [investments, setInvestments] = useState([]);
        const [budgets, setBudgets] = useState([]);
        const [privacyMode, setPrivacyMode] = useState(false);

        const [transType, setTransType] = useState('expense');
        const [transCat, setTransCat] = useState('Moradia');
        const [prefilledDate, setPrefilledDate] = useState(new Date().toISOString().split('T')[0]);

        const addToast = (msg, type='success') => { const id = Date.now(); setToasts(p => [...p, {id, msg, type}]); setTimeout(()=>setToasts(p=>p.filter(t=>t.id!==id)), 3000); };
        const toggleModal = (key, val) => setModals(p => ({...p, [key]: val}));

        // Fetch Seguro
        const fetchAll = async () => {
            try {
                const [t, g, c, i, b] = await Promise.all([
                    fetch('/api/transactions').then(r=>r.ok?r.json():[]),
                    fetch('/api/goals').then(r=>r.ok?r.json():[]),
                    fetch('/api/cards').then(r=>r.ok?r.json():[]),
                    fetch('/api/investments').then(r=>r.ok?r.json():[]),
                    fetch('/api/budgets').then(r=>r.ok?r.json():[])
                ]);
                // Garante que é array
                setTransactions(Array.isArray(t) ? t : []);
                setGoals(Array.isArray(g) ? g : []);
                setCards(Array.isArray(c) ? c : []);
                setInvestments(Array.isArray(i) ? i : []);
                setBudgets(Array.isArray(b) ? b : []);
            } catch(e) { console.error(e); }
        };

        useEffect(() => {
            const saved = localStorage.getItem('prospera_keep_login');
            if (saved) {
                setUser(JSON.parse(saved));
                setAuthMode('app');
                fetchAll();
            } else {
                setAuthMode('login');
            }
        }, []);

        const handleLogin = async (pin, keep, setError) => {
            try {
                const res = await fetch('/api/auth/login', { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({pin}) });
                const d = await res.json();
                if(d.success) {
                    if(keep) localStorage.setItem('prospera_keep_login', JSON.stringify(d.user));
                    setUser(d.user); setAuthMode('app'); fetchAll();
                } else setError(d.error);
            } catch(e) { setError("Erro de conexão"); }
        };

        const handleRegister = async (data, setError, onSuccess) => {
            try {
                const res = await fetch('/api/auth/register', { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify(data) });
                const d = await res.json();
                if(d.success) onSuccess(); else setError(d.error);
            } catch(e) { setError("Erro ao registrar"); }
        };

        const handleRecover = async (data, setError, onSuccess) => {
             try {
                const res = await fetch('/api/auth/reset', { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({name: data.name, answer: data.answer, newPin: data.pin}) });
                const d = await res.json();
                if(d.success) onSuccess(); else setError(d.error);
            } catch(e) { setError("Erro ao resetar"); }
        };

        const handleLogout = () => { localStorage.removeItem('prospera_keep_login'); setUser(null); setAuthMode('login'); };

        const handleAddTrans = async (e) => {
            e.preventDefault(); const fd = new FormData(e.target);
            const body = { description: fd.get('description'), amount: parseFloat(fd.get('amount')), type: fd.get('type'), category: transCat, subcategory: fd.get('subcategory'), date: fd.get('date'), paymentMethod: fd.get('paymentMethod'), isRecurring: fd.get('isRecurring')==='on', cardId: fd.get('cardId') };
            await fetch('/api/transactions', { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify(body) });
            addToast("Salvo!"); fetchAll(); toggleModal('transaction', false);
        };

        const deleteItem = async (type, id) => {
            await fetch(`/api/${type}/${id}`, { method: 'DELETE' });
            addToast("Excluído!"); fetchAll();
        };

        if (authMode === 'loading') return <div className="min-h-screen bg-[#050505] flex items-center justify-center"><div className="animate-spin rounded-full h-12 w-12 border-t-2 border-b-2 border-violet-500"></div></div>;
        if (authMode !== 'app') return <AuthScreen onLogin={handleLogin} onRegister={handleRegister} onRecover={handleRecover} />;

        const navItems = [ { id: 'overview', label: 'Dashboard', icon: LayoutDashboard }, { id: 'transactions', label: 'Extrato', icon: ListFilter } ];

        return (
            <div className="flex flex-col md:flex-row h-screen bg-slate-50 dark:bg-[#050505] overflow-hidden text-slate-900 dark:text-white">
                <aside className="w-24 hidden md:flex flex-col items-center py-8 z-30 h-full border-r border-slate-200 dark:border-white/5 bg-white/50 dark:bg-[#09090b]/50 backdrop-blur-sm">
                    <div className="mb-8 scale-75"><CustomLogo /></div>
                    <div className="flex-1 flex flex-col gap-4 w-full px-4">
                        {navItems.map(i => (<button key={i.id} onClick={() => setActiveTab(i.id)} className={`w-full aspect-square rounded-2xl flex flex-col items-center justify-center gap-1 transition-all ${activeTab===i.id?'bg-white/10':''}`}><i.icon size={22}/><span className="text-[9px]">{i.label}</span></button>))}
                    </div>
                    <div className="flex flex-col gap-4 px-4 pb-4"><button onClick={() => setPrivacyMode(!privacyMode)} className="w-full aspect-square rounded-2xl bg-white/5 flex items-center justify-center">{privacyMode?<EyeOff/>:<Eye/>}</button><button onClick={handleLogout} className="w-full aspect-square rounded-2xl bg-rose-500/10 text-rose-500 flex items-center justify-center"><LogOut/></button></div>
                </aside>
                <main className="flex-1 overflow-y-auto relative z-20 pb-24 md:pb-0 pt-safe">
                    <div className="max-w-7xl mx-auto p-6 md:p-10">
                        <header className="flex justify-between items-center mb-10"><div><h1 className="text-3xl font-extrabold mb-1">Olá, {user?.name}</h1><p className="text-slate-500">Bem-vindo de volta.</p></div><button onClick={() => toggleModal('transaction', true)} className={theme.btnAccent}><Plus size={18}/> Nova Transação</button></header>
                        {activeTab === 'overview' && <Overview transactions={transactions} privacyMode={privacyMode} />}
                        {activeTab === 'transactions' && <TransactionsView transactions={transactions} onDelete={(id) => deleteItem('transactions', id)} />}
                    </div>
                </main>
                <ToastContainer toasts={toasts} />
                
                {/* Modal Transação Simplificado */}
                <Modal isOpen={modals.transaction} onClose={() => toggleModal('transaction', false)} title="Nova Transação">
                    <form onSubmit={handleAddTrans} className="space-y-4">
                        <div className="grid grid-cols-2 gap-4">
                            <div><label className={theme.label}>Tipo</label><select name="type" className={theme.input} onChange={e => {setTransType(e.target.value); setTransCat(Object.keys(CATEGORIES[e.target.value])[0])}}><option value="expense">Saída</option><option value="income">Entrada</option></select></div>
                            <div><label className={theme.label}>Valor</label><input name="amount" type="number" step="0.01" className={theme.input} required /></div>
                        </div>
                        <div><label className={theme.label}>Descrição</label><input name="description" className={theme.input} required /></div>
                        <div className="grid grid-cols-2 gap-4">
                            <div><label className={theme.label}>Categoria</label><select name="category" className={theme.input} onChange={e => setTransCat(e.target.value)}>{Object.keys(CATEGORIES[transType]).map(c=><option key={c} value={c}>{c}</option>)}</select></div>
                            <div><label className={theme.label}>Data</label><input name="date" type="date" defaultValue={prefilledDate} className={theme.input} required /></div>
                        </div>
                        <button type="submit" className={theme.btnPrimary}>Salvar</button>
                    </form>
                </Modal>
            </div>
        );
    }

    const root = createRoot(document.getElementById('root'));
    root.render(<App />);
  </script>
</body>
</html>
